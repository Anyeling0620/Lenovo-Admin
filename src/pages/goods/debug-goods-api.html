<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goods API è°ƒè¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .api-section {
            margin-bottom: 30px;
        }
        .api-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .test-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .result-area {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .result-header h3 {
            color: #333;
            font-size: 16px;
        }
        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .log-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .log-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .log-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .log-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .config-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .config-label {
            font-weight: 600;
            margin-right: 10px;
            min-width: 120px;
        }
        .config-value {
            font-family: monospace;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Goods API è°ƒè¯•å·¥å…·</h1>
            <p>è¯Šæ–­å•†å“ç®¡ç†æ¨¡å—APIè¿æ¥é—®é¢˜ | Lenovo Admin System</p>
        </div>
        
        <div class="content">
            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="config-section">
                <h3 style="margin-bottom: 15px; color: #856404;">ğŸ“¡ å½“å‰é…ç½®</h3>
                <div class="config-item">
                    <div class="config-label">APIåœ°å€:</div>
                    <div class="config-value" id="apiBaseUrl">æ£€æµ‹ä¸­...</div>
                </div>
                <div class="config-item">
                    <div class="config-label">è®¤è¯çŠ¶æ€:</div>
                    <div class="config-value" id="authStatus">æœªçŸ¥</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Session ID:</div>
                    <div class="config-value" id="sessionId">æœªè®¾ç½®</div>
                </div>
            </div>

            <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
            <div class="api-section">
                <h2>ğŸ”Œ åŸºç¡€è¿æ¥æµ‹è¯•</h2>
                <div class="button-group">
                    <button class="test-btn" onclick="testConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
                    <button class="test-btn" onclick="testLogin()">æµ‹è¯•ç™»å½•æ¥å£</button>
                    <button class="test-btn" onclick="checkSession()">æ£€æŸ¥ä¼šè¯çŠ¶æ€</button>
                </div>
            </div>

            <!-- Goods API æµ‹è¯• -->
            <div class="api-section">
                <h2>ğŸ“¦ Goods API æµ‹è¯•</h2>
                <div class="button-group">
                    <button class="test-btn" onclick="testAPI('getBrands', '/admin/brands')">æµ‹è¯•è·å–å“ç‰Œ</button>
                    <button class="test-btn" onclick="testAPI('getCategories', '/admin/categories')">æµ‹è¯•è·å–åˆ†ç±»</button>
                    <button class="test-btn" onclick="testAPI('getProducts', '/admin/products')">æµ‹è¯•è·å–å•†å“</button>
                    <button class="test-btn" onclick="testAPI('getStocks', '/admin/stocks')">æµ‹è¯•è·å–åº“å­˜</button>
                    <button class="test-btn" onclick="testAPI('getTags', '/admin/tags')">æµ‹è¯•è·å–æ ‡ç­¾</button>
                    <button class="test-btn" onclick="testAPI('getProductStats', '/admin/products/stats')">æµ‹è¯•å•†å“ç»Ÿè®¡</button>
                </div>
            </div>

            <!-- æ‰¹é‡æµ‹è¯• -->
            <div class="api-section">
                <h2>âš¡ æ‰¹é‡æµ‹è¯•</h2>
                <div class="button-group">
                    <button class="test-btn" onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰Goods API</button>
                    <button class="test-btn" onclick="exportResults()">å¯¼å‡ºæµ‹è¯•ç»“æœ</button>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒº -->
            <div class="result-area">
                <div class="result-header">
                    <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
                    <button class="clear-btn" onclick="clearResults()">æ¸…ç©º</button>
                </div>
                <div id="result"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3003';
        let testResults = [];

        // åˆå§‹åŒ–
        (function init() {
            document.getElementById('apiBaseUrl').textContent = API_BASE;
            const sessionId = localStorage.getItem('admin_sessionId');
            document.getElementById('sessionId').textContent = sessionId || 'æœªè®¾ç½®';
            const auth = localStorage.getItem('auth');
            document.getElementById('authStatus').textContent = auth ? 'å·²ç™»å½•' : 'æœªç™»å½•';
        })();

        function addLog(type, message, details = null) {
            const resultDiv = document.getElementById('result');
            const logClass = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
            
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            let html = `<div class="log-item ${logClass}">
                <strong>[${timestamp}]</strong> ${message}`;
            
            if (details) {
                html += `<pre style="margin-top: 10px; background: rgba(0,0,0,0.05);">${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            html += '</div>';
            resultDiv.innerHTML = html + resultDiv.innerHTML;
            
            testResults.push({ timestamp, type, message, details });
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
            testResults = [];
        }

        async function testConnection() {
            addLog('info', 'æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
            try {
                const response = await fetch(`${API_BASE}/admin/health`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addLog('success', 'âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸', data);
                } else {
                    addLog('error', `âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addLog('error', `âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}`);
            }
        }

        async function testLogin() {
            addLog('info', 'æ­£åœ¨æµ‹è¯•ç™»å½•æ¥å£...');
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        account: '12345678901234567890',
                        password: '123456'
                    })
                });
                
                const data = await response.json();
                
                if (data.code && data.code.toString().startsWith('2')) {
                    addLog('success', 'âœ… ç™»å½•æˆåŠŸ', data);
                    
                    // ä¿å­˜ sessionId
                    if (data.data && data.data.sessionId) {
                        localStorage.setItem('admin_sessionId', data.data.sessionId);
                        document.getElementById('sessionId').textContent = data.data.sessionId;
                    }
                    
                    // æ›´æ–°è®¤è¯çŠ¶æ€
                    localStorage.setItem('auth', JSON.stringify({ isAuthenticated: true }));
                    document.getElementById('authStatus').textContent = 'å·²ç™»å½•';
                } else {
                    addLog('error', `âŒ ç™»å½•å¤±è´¥: ${data.message}`, data);
                }
            } catch (error) {
                addLog('error', `âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function checkSession() {
            addLog('info', 'æ­£åœ¨æ£€æŸ¥ä¼šè¯çŠ¶æ€...');
            try {
                const response = await fetch(`${API_BASE}/admin/account/profile`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'X-Session-ID': localStorage.getItem('admin_sessionId') || ''
                    }
                });
                
                const data = await response.json();
                
                if (data.code && data.code.toString().startsWith('2')) {
                    addLog('success', 'âœ… ä¼šè¯æœ‰æ•ˆ', data);
                } else if (data.code === 401) {
                    addLog('error', 'âŒ ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', data);
                } else {
                    addLog('error', `âŒ æ£€æŸ¥ä¼šè¯å¤±è´¥: ${data.message}`, data);
                }
            } catch (error) {
                addLog('error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function testAPI(name, endpoint) {
            addLog('info', `æ­£åœ¨æµ‹è¯• ${name}...`);
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'X-Session-ID': localStorage.getItem('admin_sessionId') || ''
                    }
                });
                
                const rawData = await response.json();
                console.log(`[${name}] åŸå§‹å“åº”:`, rawData);
                
                // æ£€æŸ¥å“åº”ç»“æ„
                if (rawData.code !== undefined) {
                    // æ ‡å‡†å“åº”æ ¼å¼
                    if (rawData.code.toString().startsWith('2')) {
                        const actualData = rawData.data;
                        const dataType = Array.isArray(actualData) ? 'æ•°ç»„' : typeof actualData;
                        const count = Array.isArray(actualData) ? actualData.length : 'N/A';
                        
                        addLog('success', 
                            `âœ… ${name} æˆåŠŸ | æ•°æ®ç±»å‹: ${dataType} | æ•°é‡: ${count}`, 
                            {
                                code: rawData.code,
                                message: rawData.message,
                                dataType,
                                count,
                                sample: Array.isArray(actualData) ? actualData.slice(0, 2) : actualData
                            }
                        );
                    } else if (rawData.code === 401) {
                        addLog('error', `âŒ ${name} å¤±è´¥: æœªæˆæƒï¼Œè¯·å…ˆç™»å½•`, rawData);
                    } else {
                        addLog('error', `âŒ ${name} å¤±è´¥: ${rawData.message}`, rawData);
                    }
                } else {
                    // éæ ‡å‡†å“åº”
                    addLog('error', `âŒ ${name} å“åº”æ ¼å¼å¼‚å¸¸: ç¼ºå°‘codeå­—æ®µ`, rawData);
                }
            } catch (error) {
                addLog('error', `âŒ ${name} è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function testAllAPIs() {
            const apis = [
                { name: 'å“ç‰Œåˆ—è¡¨', endpoint: '/admin/brands' },
                { name: 'åˆ†ç±»åˆ—è¡¨', endpoint: '/admin/categories' },
                { name: 'å•†å“åˆ—è¡¨', endpoint: '/admin/products' },
                { name: 'åº“å­˜åˆ—è¡¨', endpoint: '/admin/stocks' },
                { name: 'æ ‡ç­¾åˆ—è¡¨', endpoint: '/admin/tags' },
                { name: 'å•†å“ç»Ÿè®¡', endpoint: '/admin/products/stats' },
            ];

            addLog('info', `ğŸš€ å¼€å§‹æ‰¹é‡æµ‹è¯• ${apis.length} ä¸ªAPI...`);
            
            for (const api of apis) {
                await testAPI(api.name, api.endpoint);
                await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿ500ms
            }
            
            addLog('info', 'âœ¨ æ‰¹é‡æµ‹è¯•å®Œæˆ');
        }

        function exportResults() {
            const dataStr = JSON.stringify(testResults, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `goods-api-test-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addLog('success', 'âœ… æµ‹è¯•ç»“æœå·²å¯¼å‡º');
        }
    </script>
</body>
</html>
